extends ../layout/templatetrips
block content
  main.main
        ol.breadcrumb
          li.breadcrumb-item Clientes
          li.breadcrumb-item Veiculos
          li.breadcrumb-item.active Último trajeto
        .container-fluid
          .animated.fadeIn         
            #mapid(style='padding-top: 0px; width: 960px;height: 500px;position: relative;margin:0 auto;line-height: 1.4em;')
            script.
                var mymap = L.map('mapid').setView([-3.0658966666666667,-60.013075], 13);

                L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                  maxZoom: 18,
                  attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                  '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                  'Imagery © <a href="http://mapbox.com">Mapbox</a>',
                  id: 'mapbox.streets'
                }).addTo(mymap);
           #cnttable(style='position: absolute; top:150px; left: 230px;  width:180px;  height:30px; z-index: 2000;')
                          table.table.table-responsive.table-hover.table-outline.mb-0
                            thead.thead-default
                              tr                           
                                th Veículos                            
                            tbody
                              each carro in carros
                                tr                           
                                  td
                                    div                             
                                      //- button.btn-link(onclick='executeQuery(#{carro.deviceHex})') #{carro.plate}
                                      button.btn-link(onclick='executeQuery("#{carro.device}","Viatura")') #{carro.plate}
                          if (pages > 1)
                            ul.pagination
                              != createPagination(pages, page)     
script(type='text/javascript').

                         function executeQuery(dongle, plate) {
                              jQuery.support.cors = true;
                              $.ajax
                              ({
                                type: "get",
                                url: "/message/gps/" + dongle,
                                dataType: "json",
                                crossDomain: "true",
                                contentType: "application/json; charset=UTF-8"                                                             
                              }).done(function ( data ) {    
                                //- console.log('Data=>'+ data);                            
                                success(data,plate);
                                //- getPolyline(dongle);
                              });
                          };   

                          function success(position, pl) {
                            var geoloc =  position.message.gpsData.split(',');
                            var lati = geoloc[0];
                            var logi = geoloc[1];
                            
                            var pos = new Microsoft.Maps.Location(lati, logi);
                            //- p++;                            
                            if(pushpin){
                              pushpin.setLocation(pos);                              
                            }else{
                              
                              var pushpinOptions = {title: pl};
                              pushpin = new Microsoft.Maps.Pushpin(pos, pushpinOptions);

                              map.entities.push(pushpin);
                              //- map.entities.push(callout);
                            }

                             map.setView({center:pos});
                            //-  reverseGeocode();
                      };                             